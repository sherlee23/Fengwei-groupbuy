<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>锋味派美食团购</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #FF4757;
      --secondary: #FF6B81;
      --accent: #FFA502;
      --light: #F1F2F6;
      --dark: #2F3542;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      color: var(--dark);
    }

    .container {
      max-width: 640px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      padding: 20px;
      text-align: center;
      color: white;
      border-radius: 0 0 16px 16px;
    }

    .header h1 {
      margin: 0;
      font-size: 24px;
    }

    h2.category-title {
      font-size: 20px;
      margin: 30px 0 10px;
      padding-left: 10px;
      border-left: 5px solid var(--primary);
    }

    .product {
      background: white;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .product-image-container {
      width: 100%;
      height: 180px;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 10px;
      background: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .product-image {
      max-height: 100%;
      max-width: 100%;
      object-fit: cover;
    }

    .product-name {
      font-weight: bold;
      margin-bottom: 6px;
      font-size: 16px;
    }

    .product-price {
      color: var(--primary);
      font-weight: bold;
      margin-bottom: 10px;
    }

    .quantity-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .quantity-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--primary);
      color: white;
      font-size: 20px;
      border-radius: 50%;
      cursor: pointer;
    }

    .quantity-input {
      width: 60px;
      text-align: center;
      font-size: 16px;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .total {
      background: #fff;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
      text-align: right;
      margin-top: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .form-group {
      margin-top: 20px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 15px;
    }

    .form-group textarea {
      height: 48px;
      resize: vertical;
    }

    .submit-btn {
      width: 100%;
      padding: 14px;
      margin-top: 24px;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .file-upload {
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      border: 1px dashed #ccc;
      margin-top: 20px;
    }

    .file-upload input[type="file"] {
      width: 100%;
    }

    .bank-info {
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      margin-top: 20px;
      border: 1px solid #eee;
    }

    .bank-info img {
      width: 48%;
      border-radius: 8px;
      margin-top: 10px;
    }

    .disclaimer-box {
      background-color: #fff3f3;
      border-left: 5px solid var(--primary);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .disclaimer-checkbox {
      margin-top: 10px;
    }

    .confirmation-dialog {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .confirmation-box {
      background: white;
      padding: 20px;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .confirmation-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    .confirmation-btn {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }

    .confirmation-cancel {
      background: #ccc;
    }

    .confirmation-submit {
      background: var(--primary);
      color: white;
    }

    .admin-export {
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      margin-top: 30px;
      border: 1px solid #eee;
    }

    .admin-export input {
      margin-top: 10px;
      margin-bottom: 10px;
    }

    .emoji {
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>🍢 锋味派美食团购</h1>
  </div>
  <div class="container">

    <form id="orderForm">
      <!-- 重要声明 -->
      <div class="disclaimer-box">
        <h3>⚠️ 重要声明 / Important Notice</h3>
        <p>1. 此为预购商品，我们将收集所有订单后统一向供应商下单。<br>1. This is a pre-order. We will place the bulk order after collecting all purchases.</p>
        <p>2. 预计等待时间：30-60天（从下单日起计算）。<br>2. Estimated waiting time: 30-60 days (from order date).</p>
        <p>3. 当前价格<strong>不包含</strong>国际运费，运费将根据实际物流成本后续通知收取。<br>3. Prices <strong>do not include</strong> international shipping fees. Fees will be calculated later.</p>
        <div class="disclaimer-checkbox">
          <label>
            <input type="checkbox" id="agreeCheckbox" /> 我已阅读并同意上述条款
          </label>
        </div>
      </div>

      <!-- 顾客信息 -->
      <div class="form-group">
        <label for="name"><span class="emoji">👤</span>姓名 *</label>
        <input type="text" id="name" name="name" required />
      </div>

      <div class="form-group">
        <label for="phone"><span class="emoji">📱</span>电话 *</label>
        <input type="tel" id="phone" name="phone" required />
      </div>

      <div class="form-group">
        <label for="delivery"><span class="emoji">🚚</span>取货方式 *</label>
        <select id="delivery" name="delivery" required>
          <option value="">请选择...</option>
          <option value="self-pickup">自取 Self Pickup</option>
          <option value="lalamove">Lalamove 送货</option>
        </select>
      </div>

      <h2 class="category-title"><span class="emoji">🛒</span>请选择商品</h2>

      <!-- 商品清单：烤肠系列 -->
      <h2 class="category-title"><span class="emoji">🌭</span>烤肠系列</h2>

      <div class="product">
        <div class="product-image-container">
          <img src="IMG_3859.jpeg" class="product-image" alt="原味烤肠" />
        </div>
        <div class="product-name">原味烤肠 <span class="tag">🔥 爆款</span></div>
        <div class="product-price">RM28</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="原味烤肠">-</button>
          <input type="number" class="quantity-input" id="原味烤肠" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="原味烤肠">+</button>
        </div>
      </div>

      <div class="product">
        <div class="product-image-container">
          <img src="IMG_3864.jpeg" class="product-image" alt="烟熏蜜汁烤肠" />
        </div>
        <div class="product-name">烟熏蜜汁烤肠</div>
        <div class="product-price">RM28</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="烟熏蜜汁烤肠">-</button>
          <input type="number" class="quantity-input" id="烟熏蜜汁烤肠" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="烟熏蜜汁烤肠">+</button>
        </div>
      </div>

      <div class="product">
        <div class="product-image-container">
          <img src="IMG_3863.jpeg" class="product-image" alt="法式香草烤肠" />
        </div>
        <div class="product-name">法式香草烤肠</div>
        <div class="product-price">RM28</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="法式香草烤肠">-</button>
          <input type="number" class="quantity-input" id="法式香草烤肠" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="法式香草烤肠">+</button>
        </div>
      </div>

      <div class="product">
        <div class="product-image-container">
          <img src="IMG_3860.jpeg" class="product-image" alt="黑胡椒烤肠" />
        </div>
        <div class="product-name">黑胡椒烤肠</div>
        <div class="product-price">RM28</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="黑胡椒烤肠">-</button>
          <input type="number" class="quantity-input" id="黑胡椒烤肠" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="黑胡椒烤肠">+</button>
        </div>
      </div>

      <div class="product">
        <div class="product-image-container">
          <img src="IMG_3862.jpeg" class="product-image" alt="孜然脆骨烤肠" />
        </div>
        <div class="product-name">孜然脆骨烤肠</div>
        <div class="product-price">RM28</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="孜然脆骨烤肠">-</button>
          <input type="number" class="quantity-input" id="孜然脆骨烤肠" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="孜然脆骨烤肠">+</button>
        </div>
      </div>

      <div class="product">
        <div class="product-image-container">
          <img src="IMG_3861.jpeg" class="product-image" alt="芝士玉米烤肠" />
        </div>
        <div class="product-name">芝士玉米烤肠</div>
        <div class="product-price">RM28</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="芝士玉米烤肠">-</button>
          <input type="number" class="quantity-input" id="芝士玉米烤肠" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="芝士玉米烤肠">+</button>
        </div>
      </div>

      <!-- 虾肠系列 -->
      <h2 class="category-title"><span class="emoji">🦐</span>虾肠&虾饼系列</h2>
      <div class="product">
        <div class="product-image-container"><img src="IMG_3853.jpeg" class="product-image" alt="原味虾肠" /></div>
        <div class="product-name">原味虾肠 <span class="tag">🆕 新品</span></div>
        <div class="product-price">RM33</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="原味虾肠">-</button>
          <input type="number" class="quantity-input" id="原味虾肠" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="原味虾肠">+</button>
        </div>
      </div>
      <div class="product">
        <div class="product-image-container"><img src="IMG_3854.jpeg" class="product-image" alt="辣味虾肠" /></div>
        <div class="product-name">辣味虾肠 <span class="tag">🌶️ 热卖</span></div>
        <div class="product-price">RM33</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="辣味虾肠">-</button>
          <input type="number" class="quantity-input" id="辣味虾肠" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="辣味虾肠">+</button>
        </div>
      </div>
      <div class="product">
        <div class="product-image-container"><img src="IMG_3873.jpeg" class="product-image" alt="虾饼" /></div>
        <div class="product-name">虾饼</div>
        <div class="product-price">RM28</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="虾饼">-</button>
          <input type="number" class="quantity-input" id="虾饼" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="虾饼">+</button>
        </div>
      </div>

      <!-- 披萨系列 -->
      <h2 class="category-title"><span class="emoji">🍕</span>披萨系列</h2>
      <div class="product">
        <div class="product-image-container"><img src="IMG_3841.jpeg" class="product-image" alt="玛格丽特披萨" /></div>
        <div class="product-name">玛格丽特披萨</div>
        <div class="product-price">RM25</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="玛格丽特披萨">-</button>
          <input type="number" class="quantity-input" id="玛格丽特披萨" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="玛格丽特披萨">+</button>
        </div>
      </div>
      <div class="product">
        <div class="product-image-container"><img src="IMG_3839.jpeg" class="product-image" alt="黑椒牛肉披萨" /></div>
        <div class="product-name">黑椒牛肉披萨</div>
        <div class="product-price">RM25</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="黑椒牛肉披萨">-</button>
          <input type="number" class="quantity-input" id="黑椒牛肉披萨" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="黑椒牛肉披萨">+</button>
        </div>
      </div>
      <div class="product">
        <div class="product-image-container"><img src="IMG_3840.jpeg" class="product-image" alt="奥尔良鸡肉披萨" /></div>
        <div class="product-name">奥尔良鸡肉披萨</div>
        <div class="product-price">RM25</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="奥尔良鸡肉披萨">-</button>
          <input type="number" class="quantity-input" id="奥尔良鸡肉披萨" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="奥尔良鸡肉披萨">+</button>
        </div>
      </div>
      <div class="product">
        <div class="product-image-container"><img src="IMG_3852.jpeg" class="product-image" alt="双料榴莲披萨" /></div>
        <div class="product-name">双料榴莲披萨 <span class="tag">🌟 招牌</span></div>
        <div class="product-price">RM40</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="双料榴莲披萨">-</button>
          <input type="number" class="quantity-input" id="双料榴莲披萨" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="双料榴莲披萨">+</button>
        </div>
      </div>

      <!-- 酥饼系列 -->
      <h2 class="category-title"><span class="emoji">🥮</span>酥饼系列</h2>
      <div class="product">
        <div class="product-image-container"><img src="IMG_3837.jpeg" class="product-image" alt="黑猪肉酥饼" /></div>
        <div class="product-name">黑猪肉酥饼</div>
        <div class="product-price">RM55</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="黑猪肉酥饼">-</button>
          <input type="number" class="quantity-input" id="黑猪肉酥饼" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="黑猪肉酥饼">+</button>
        </div>
      </div>
      <div class="product">
        <div class="product-image-container"><img src="IMG_3838.jpeg" class="product-image" alt="安格斯牛肉酥饼" /></div>
        <div class="product-name">安格斯牛肉酥饼</div>
        <div class="product-price">RM55</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="安格斯牛肉酥饼">-</button>
          <input type="number" class="quantity-input" id="安格斯牛肉酥饼" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="安格斯牛肉酥饼">+</button>
        </div>
      </div>

      <!-- 小笼汤包系列 -->
      <h2 class="category-title"><span class="emoji">🥟</span>小笼汤包系列</h2>
      <div class="product">
        <div class="product-image-container"><img src="IMG_3874.jpeg" class="product-image" alt="鲜肉小笼汤包" /></div>
        <div class="product-name">鲜肉小笼汤包</div>
        <div class="product-price">RM12</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="鲜肉小笼汤包">-</button>
          <input type="number" class="quantity-input" id="鲜肉小笼汤包" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="鲜肉小笼汤包">+</button>
        </div>
      </div>
      <div class="product">
        <div class="product-image-container"><img src="IMG_3875.jpeg" class="product-image" alt="菌菇小笼汤包" /></div>
        <div class="product-name">菌菇小笼汤包</div>
        <div class="product-price">RM12</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="菌菇小笼汤包">-</button>
          <input type="number" class="quantity-input" id="菌菇小笼汤包" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="菌菇小笼汤包">+</button>
        </div>
      </div>
      <div class="product">
        <div class="product-image-container"><img src="IMG_3876.jpeg" class="product-image" alt="黑松露小笼汤包" /></div>
        <div class="product-name">黑松露小笼汤包 <span class="tag">💎 豪华</span></div>
        <div class="product-price">RM12</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="黑松露小笼汤包">-</button>
          <input type="number" class="quantity-input" id="黑松露小笼汤包" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="黑松露小笼汤包">+</button>
        </div>
      </div>

      <!-- 鸡排系列 -->
      <h2 class="category-title"><span class="emoji">🍗</span>鸡排系列</h2>
      <div class="product">
        <div class="product-image-container"><img src="IMG_3835.jpeg" class="product-image" alt="原味鸡排" /></div>
        <div class="product-name">原味鸡排 <span class="tag">🏆 无抗认证</span></div>
        <div class="product-price">RM20</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="原味鸡排">-</button>
          <input type="number" class="quantity-input" id="原味鸡排" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="原味鸡排">+</button>
        </div>
      </div>
      <div class="product">
        <div class="product-image-container"><img src="IMG_3836.jpeg" class="product-image" alt="奥尔良鸡排" /></div>
        <div class="product-name">奥尔良鸡排</div>
        <div class="product-price">RM20</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="奥尔良鸡排">-</button>
          <input type="number" class="quantity-input" id="奥尔良鸡排" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="奥尔良鸡排">+</button>
        </div>
      </div>

      <!-- 鸡翅系列 -->
      <h2 class="category-title"><span class="emoji">🍗</span>鸡翅系列</h2>
      <div class="product">
        <div class="product-image-container"><img src="IMG_3865.jpeg" class="product-image" alt="奥尔良鸡翅" /></div>
        <div class="product-name">奥尔良鸡翅</div>
        <div class="product-price">RM25</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="奥尔良鸡翅">-</button>
          <input type="number" class="quantity-input" id="奥尔良鸡翅" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="奥尔良鸡翅">+</button>
        </div>
      </div>
      <div class="product">
        <div class="product-image-container"><img src="IMG_3866.jpeg" class="product-image" alt="青花椒鸡翅" /></div>
        <div class="product-name">青花椒鸡翅 <span class="tag">🌶️ 麻辣</span></div>
        <div class="product-price">RM25</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="青花椒鸡翅">-</button>
          <input type="number" class="quantity-input" id="青花椒鸡翅" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="青花椒鸡翅">+</button>
        </div>
      </div>

      <!-- 纸皮烧卖系列 -->
      <h2 class="category-title"><span class="emoji">🥟</span>纸皮烧卖系列</h2>
      <div class="product">
        <div class="product-image-container"><img src="IMG_3843.jpeg" class="product-image" alt="黑猪三丁纸皮烧卖" /></div>
        <div class="product-name">黑猪三丁纸皮烧卖</div>
        <div class="product-price">RM15</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="黑猪三丁纸皮烧卖">-</button>
          <input type="number" class="quantity-input" id="黑猪三丁纸皮烧卖" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="黑猪三丁纸皮烧卖">+</button>
        </div>
      </div>
      <div class="product">
        <div class="product-image-container"><img src="IMG_3842.jpeg" class="product-image" alt="黑椒牛肉纸皮烧卖" /></div>
        <div class="product-name">黑椒牛肉纸皮烧卖</div>
        <div class="product-price">RM15</div>
        <div class="quantity-control">
          <button type="button" class="quantity-btn minus" data-product="黑椒牛肉纸皮烧卖">-</button>
          <input type="number" class="quantity-input" id="黑椒牛肉纸皮烧卖" value="0" min="0" />
          <button type="button" class="quantity-btn plus" data-product="黑椒牛肉纸皮烧卖">+</button>
        </div>
      </div>

      <!-- 总金额 -->
      <div class="total">共计：RM<span id="totalAmount">0</span></div>

      <!-- 备注栏 -->
      <div class="form-group">
        <label for="remarks"><span class="emoji">📝</span>备注 (可选)</label>
        <textarea id="remarks" name="remarks" placeholder="填写您希望备注的内容，例如：不要辣、不含花生等"></textarea>
      </div>

      <!-- 银行转账信息 -->
      <div class="bank-info">
        <strong>银行名称：</strong>Maybank<br />
        <strong>户口名称：</strong>Choong Sher Lee<br />
        <strong>户口号码：</strong>114209540438
        <div style="display:flex; gap:4%; justify-content:space-between;">
          <img src="IMG_4043.jpeg" alt="QR Code 1" />
          <img src="IMG_4042.png" alt="QR Code 2" />
        </div>
      </div>

      <!-- 上传转账凭证 -->
      <div class="form-group file-upload">
        <label for="payment"><span class="emoji">💳</span>请上传转账凭证 *</label>
        <input type="file" id="payment" name="payment" accept="image/*,.pdf" required />
      </div>

      <!-- 提交按钮 -->
      <button type="submit" class="submit-btn"><span class="emoji">🚀</span> 提交订单</button>
    </form>

    <!-- 管理员导出区域 -->
    <div class="admin-export">
      <h3 style="margin-top:0">管理员导出</h3>
      <input type="password" id="adminPassword" placeholder="请输入导出密码" />
      <button id="realExportBtn" class="submit-btn" style="margin-top:8px;">📤 导出 Excel</button>
    </div>

    <button id="showExportBtn" class="submit-btn" style="background: #6c757d; margin-top: 16px;">🔐 管理员导出订单</button>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const SUPABASE_URL = 'https://edfnhhthztskuuosuasw.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkZm5oaHRoenRza3V1b3N1YXN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5OTYxMTYsImV4cCI6MjA2NTU3MjExNn0.O3g2gjvsWagmWgmzoeJA8mPampvLYJr-KgqVwXsKoAo';
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  function calculateTotal() {
    let total = 0;
    document.querySelectorAll('.quantity-input').forEach(input => {
      const qty = parseInt(input.value) || 0;
      if (qty > 0) {
        const price = parseFloat(input.closest('.product').querySelector('.product-price').textContent.replace('RM', ''));
        total += qty * price;
      }
    });
    document.getElementById('totalAmount').textContent = total.toFixed(2);
    return total;
  }

  // 加减按钮功能
  document.querySelectorAll('.quantity-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const input = document.getElementById(btn.dataset.product);
      let val = parseInt(input.value) || 0;
      val = btn.classList.contains('plus') ? val + 1 : Math.max(0, val - 1);
      input.value = val;
      calculateTotal();
    });
  });

  // 手动输入数量监听
  document.querySelectorAll('.quantity-input').forEach(input => {
    input.addEventListener('input', () => {
      input.value = Math.max(0, parseInt(input.value) || 0);
      calculateTotal();
    });
  });

  // 构造 WhatsApp 消息内容
  function buildWhatsAppMessage(order) {
    const phoneFormatted = order.phone.replace(/\D/g, '').replace(/^0/, '60');
    let msg = `*🛎️ [新订单] 锋味派订单 #${order.order_id}*%0A%0A`;
    msg += `👤 *客户信息*:%0A`;
    msg += `▫️ 姓名: ${order.name}%0A`;
    msg += `▫️ 电话: https://wa.me/${phoneFormatted}%0A`;
    msg += `▫️ 取货方式: ${order.delivery}%0A%0A`;
    msg += `🛒 *订单内容*:%0A`;
    order.items.forEach(item => {
      msg += `▫️ ${item.product} × ${item.quantity} = RM${(item.quantity * item.price).toFixed(2)}%0A`;
    });
    msg += `%0A💰 *总金额: RM${order.total.toFixed(2)}*%0A`;
    msg += `📝 *备注*: ${order.remarks || '（无）'}%0A`;
    msg += `📅 下单时间: ${new Date().toLocaleString('zh-CN')}`;
    return msg;
  }

  // 提交订单
  async function submitOrder(orderData, whatsappMessage) {
    try {
      const fileInput = document.getElementById('payment');
      const file = fileInput.files[0];
      let paymentProofUrl = '';
      if (file) {
        const ext = file.name.split('.').pop();
        const fileName = `proofs/${Date.now()}_${Math.random().toString(36).substring(2)}.${ext}`;
        const { error: uploadError } = await supabase.storage.from('payment-proofs').upload(fileName, file);
        if (uploadError) throw uploadError;
        const { data } = supabase.storage.from('payment-proofs').getPublicUrl(fileName);
        paymentProofUrl = data.publicUrl;
      }

      await supabase.from('orders').insert([{
        order_id: orderData.order_id,
        name: orderData.name,
        phone: orderData.phone,
        delivery_method: orderData.delivery,
        order_items: orderData.items,
        total_amount: orderData.total,
        remarks: orderData.remarks,
        payment_proof_url: paymentProofUrl,
        created_at: new Date().toISOString()
      }]);

      // 跳转 WhatsApp
      const url = `https://wa.me/60162327792?text=${encodeURIComponent(whatsappMessage)}`;
      const link = document.createElement('a');
      link.href = url;
      link.target = '_blank';
      link.rel = 'noopener noreferrer';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      alert('订单已提交并发送至 WhatsApp');
    } catch (err) {
      console.error('提交失败：', err);
      alert('提交失败，请检查网络或稍后再试');
    }
  }

  // 表单验证
  function validateForm() {
    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const delivery = document.getElementById('delivery').value;
    const agree = document.getElementById('agreeCheckbox').checked;
    const payment = document.getElementById('payment').files.length > 0;
    const total = calculateTotal();
    if (!name || !phone || !delivery || !agree || !payment) {
      alert('请填写所有必填项并同意声明');
      return false;
    }
    if (total === 0) {
      alert('请至少选择一个商品');
      return false;
    }
    return true;
  }

  // 构造订单数据 + 弹出确认
  function showOrderConfirmation() {
    const items = [];
    document.querySelectorAll('.quantity-input').forEach(input => {
      const qty = parseInt(input.value) || 0;
      if (qty > 0) {
        const productDiv = input.closest('.product');
        const name = input.id;
        const price = parseFloat(productDiv.querySelector('.product-price').textContent.replace('RM', ''));
        items.push({ product: name, quantity: qty, price });
      }
    });

    const orderId = `FWP${Date.now()}`;
    const orderData = {
      order_id: orderId,
      name: document.getElementById('name').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      delivery: document.getElementById('delivery').value,
      remarks: document.getElementById('remarks').value.trim(),
      items,
      total: calculateTotal()
    };
    const message = buildWhatsAppMessage(orderData);

    let preview = `🧾 *订单预览*\n姓名：${orderData.name}\n电话：${orderData.phone}\n方式：${orderData.delivery}\n`;
    orderData.items.forEach(i => preview += `${i.product} × ${i.quantity} = RM${(i.price * i.quantity).toFixed(2)}\n`);
    preview += `总金额：RM${orderData.total.toFixed(2)}\n备注：${orderData.remarks || '无'}`;

    if (confirm(`${preview}\n\n确认无误后将提交并发送 WhatsApp 消息`)) {
      submitOrder(orderData, message);
    }
  }

  // 表单提交监听
  document.getElementById('orderForm').addEventListener('submit', e => {
    e.preventDefault();
    if (validateForm()) {
      showOrderConfirmation();
    }
  });

  // 管理员导出
  document.getElementById('showExportBtn').onclick = () => {
    document.querySelector('.admin-export').style.display = 'block';
  };
  document.getElementById('realExportBtn').onclick = async () => {
    const pass = document.getElementById('adminPassword').value;
    if (pass !== 'fengweipaiadmin') {
      alert('密码错误');
      return;
    }
    const { data, error } = await supabase.from('orders').select('*');
    if (error) return alert('导出失败');

    const rows = data.map(row => ({
      order_id: row.order_id,
      name: row.name,
      phone: row.phone,
      delivery_method: row.delivery_method,
      items: row.order_items.map(i => `${i.product}×${i.quantity}`).join(', '),
      total_amount: row.total_amount,
      remarks: row.remarks,
      created_at: row.created_at
    }));
    const worksheet = XLSX.utils.json_to_sheet(rows);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, 'Orders');
    XLSX.writeFile(workbook, `锋味派订单_${new Date().toISOString().slice(0,10)}.xlsx`);
  };
});
</script>
