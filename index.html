<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é”‹å‘³æ´¾ç¾é£Ÿå›¢è´­</title>
    <meta name="description" content="é”‹å‘³æ´¾ç¾é£Ÿå›¢è´­å¹³å° - æ–°é²œç¾é£Ÿï¼Œå›¢è´­ä¼˜æƒ " />
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* CSS Custom Properties */
        :root {
            --primary: #d10000; --secondary: #000000; --accent: #f8b500; --light: #f8f8f8; --dark: #333333;
            --success: #28a745; --warning: #ffc107; --danger: #dc3545; --info: #17a2b8;
            --bg-gradient: linear-gradient(135deg, #f9f9f9 0%, #eeeeee 100%);
            --section-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08); --shadow-hover: 0 8px 16px rgba(0, 0, 0, 0.12);
            --border-radius: 12px; --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); max-width: 800px; margin: 0 auto; background: var(--bg-gradient); color: var(--dark); line-height: 1.6; }

        /* All other styles from your original file are preserved */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 9999; backdrop-filter: blur(5px); }
        .loading-spinner { text-align: center; color: white; }
        .loading-spinner i { font-size: 48px; margin-bottom: 16px; color: var(--primary); }
        .header { text-align: center; padding: 32px 20px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; border-radius: 0 0 24px 24px; margin-bottom: 24px; box-shadow: var(--shadow); }
        .header h1 { margin: 0 0 8px 0; font-size: clamp(24px, 5vw, 32px); }
        .category-nav { position: sticky; top: 0; background: white; z-index: 100; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; border-radius: var(--border-radius); }
        .category-links { display: flex; overflow-x: auto; gap: 12px; padding-bottom: 4px; scrollbar-width: none; }
        .category-links::-webkit-scrollbar { display: none; }
        .category-link { white-space: nowrap; padding: 8px 16px; background: #f5f5f5; border-radius: 20px; text-decoration: none; color: var(--dark); }
        .category-link.active, .category-link:hover { background: var(--primary); color: white; }
        .main-content { padding: 0 20px 40px; }
        .container { background: var(--section-bg); border-radius: var(--border-radius); padding: 24px; margin-bottom: 24px; box-shadow: var(--shadow); }
        .section-title { font-size: 24px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
        .section-title i { color: var(--primary); }
        .product-list { display: grid; gap: 20px; margin-bottom: 24px; }
        .product { background: white; border-radius: var(--border-radius); padding: 20px; box-shadow: var(--shadow); border-left: 4px solid var(--primary); }
        .product.out-of-stock { opacity: 0.7; }
        .product-image-container { width: 100%; height: 200px; overflow: hidden; border-radius: 8px; margin-bottom: 16px; position: relative; }
        .product-image { max-width: 100%; max-height: 100%; object-fit: cover; }
        .product-name { font-size: 18px; font-weight: 700; }
        .product-price { color: var(--primary); font-size: 20px; font-weight: 700; }
        .stock-info { margin: 8px 0; text-align: center; }
        .stock-count { font-size: 14px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
        .stock-count.in-stock { color: var(--success); } .stock-count.low-stock { color: var(--warning); } .stock-count.out-of-stock { color: var(--danger); }
        .stock-badge { position: absolute; top: 8px; right: 8px; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; z-index: 1; }
        .out-of-stock-badge { background: var(--danger); color: white; } .low-stock-badge { background: var(--warning); color: #212529; }
        .out-of-stock-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(220, 53, 69, 0.9); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; z-index: 2; }
        .quantity-control { display: flex; align-items: center; gap: 12px; justify-content: center; }
        .quantity-btn { width: 40px; height: 40px; border: none; border-radius: 8px; background: var(--primary); color: white; font-size: 18px; cursor: pointer; }
        .quantity-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .quantity-input { width: 60px; height: 40px; text-align: center; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; }
        .cart-summary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 20px; border-radius: var(--border-radius); text-align: center; margin-top: 24px; }
        .total { font-size: 24px; font-weight: 700; }
        .form-group { margin-bottom: 24px; position: relative; }
        .form-group label { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; }
        .required { color: var(--danger); }
        input[type="text"], input[type="tel"], select, textarea { width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: var(--border-radius); font-size: 16px; box-sizing: border-box; }
        .error-message { color: var(--danger); font-size: 14px; margin-top: 6px; display: none; }
        .form-group.error .error-message, .disclaimer-box.error .error-message { display: block; }
        .form-group.error input, .form-group.error select { border-color: var(--danger); }
        .file-upload-label { display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 8px; padding: 24px; background: var(--light); border: 2px dashed #d0d0d0; border-radius: var(--border-radius); cursor: pointer; }
        .file-upload input[type="file"] { display: none; }
        .file-name { color: var(--primary); font-weight: 600; }
        .disclaimer-box { background: #fff9f9; padding: 24px; border-radius: var(--border-radius); margin-bottom: 24px; border-left: 4px solid var(--primary); }
        .disclaimer-checkbox { display: flex; align-items: flex-start; gap: 12px; margin-top: 20px; }
        .disclaimer-checkbox input[type="checkbox"] { width: 20px; height: 20px; flex-shrink: 0; margin-top: 2px; }
        .disclaimer-box.error { border-left-color: var(--danger); }
        .pickup-address { background: #f0f8ff; padding: 16px; border-radius: var(--border-radius); margin-top: 12px; border-left: 4px solid #2196f3; }
        .bank-info { background: linear-gradient(135deg, #fff9f9, #fff5f5); padding: 24px; border-radius: var(--border-radius); margin-top: 24px; border-left: 4px solid var(--primary); }
        .payment-action { margin: 16px 0; text-align: center; }
        .qr-placeholder { width: 100%; height: 200px; background: white; border: 2px dashed #d0d0d0; display: flex; justify-content: center; align-items: center; }
        .qr-placeholder img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .dialog-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
        .dialog-overlay.show { display: flex; }
        .dialog-content { background: white; border-radius: var(--border-radius); max-width: 500px; width: 100%; }
        .dialog-header { padding: 24px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .dialog-footer { padding: 20px 24px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 12px; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 24px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: var(--border-radius); font-size: 16px; cursor: pointer; }
        .btn-secondary { background: var(--dark); }
        .submit-btn { width: 100%; padding: 18px; font-size: 18px; margin-top: 24px; }
        .admin-section { margin-top: 40px; background: white; padding: 24px; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1100; }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><p>å¤„ç†ä¸­...</p></div>
    </div>
    <header class="header">
        <h1><i class="fas fa-utensils"></i> é”‹å‘³æ´¾ç¾é£Ÿå›¢è´­</h1>
        <p class="header-subtitle">æ–°é²œç¾é£Ÿï¼Œå›¢è´­ä¼˜æƒ </p>
    </header>
    <nav class="category-nav" id="categoryNav">
        <div class="category-links">
            <a href="#all" class="category-link active" data-category="all">å…¨éƒ¨</a>
            <a href="#sausage" class="category-link" data-category="çƒ¤è‚ ç³»åˆ—">ğŸŒ­ çƒ¤è‚ ç³»åˆ—</a>
            <a href="#shrimp" class="category-link" data-category="è™¾è‚ ç³»åˆ—">ğŸ¦ è™¾è‚ ç³»åˆ—</a>
            <a href="#pizza" class="category-link" data-category="æŠ«è¨ç³»åˆ—">ğŸ• æŠ«è¨ç³»åˆ—</a>
            <a href="#dumpling" class="category-link" data-category="å°ç¬¼æ±¤åŒ…ç³»åˆ—">ğŸ¥Ÿ å°ç¬¼æ±¤åŒ…ç³»åˆ—</a>
            <a href="#pastry" class="category-link" data-category="é…¥é¥¼ç³»åˆ—">ğŸ¥® é…¥é¥¼ç³»åˆ—</a>
            <a href="#chicken" class="category-link" data-category="é¸¡æ’ç³»åˆ—">ğŸ— é¸¡æ’ç³»åˆ—</a>
            <a href="#wings" class="category-link" data-category="é¸¡ç¿…ç³»åˆ—">ğŸ— é¸¡ç¿…ç³»åˆ—</a>
            <a href="#shumai" class="category-link" data-category="çº¸çš®çƒ§å–ç³»åˆ—">ğŸ¥Ÿ çº¸çš®çƒ§å–ç³»åˆ—</a>
        </div>
    </nav>
    <main class="main-content">
        <section class="disclaimer-box" id="disclaimerBox">
            <h3><i class="fas fa-exclamation-triangle"></i> é‡è¦å£°æ˜ / Important Notice</h3>
            <ul>
                <li>æ­¤ä¸ºé¢„è´­å•†å“ï¼Œè®¢å•æ±‡æ€»åç»Ÿä¸€å‘ä¾›åº”å•†è®¢è´­</li>
                <li>é¢„è®¡ç­‰å¾…æ—¶é—´ï¼š30-60å¤©ï¼ˆä»ä¸‹å•æ—¥èµ·è®¡ç®—ï¼‰</li>
                <li>å½“å‰ä»·æ ¼<strong>ä¸åŒ…å«</strong>å›½é™…è¿è´¹ï¼Œè¿è´¹å°†æ ¹æ®å®é™…ç‰©æµæˆæœ¬åç»­é€šçŸ¥æ”¶å–</li>
            </ul>
            <div class="disclaimer-checkbox">
                <input type="checkbox" id="agreeTerms" name="agreeTerms" required>
                <label for="agreeTerms">æˆ‘å·²é˜…è¯»å¹¶åŒæ„ä¸Šè¿°æ¡æ¬¾ <span class="required">*</span></label>
            </div>
            <div class="error-message"></div>
        </section>
        <section class="container" id="orderForm">
            <h2 class="section-title"><i class="fas fa-user-edit"></i> è®¢å•ä¿¡æ¯</h2>
            <form id="mainForm" novalidate>
                <div class="form-group">
                    <label for="customerName"><i class="fas fa-user"></i> å§“å <span class="required">*</span></label>
                    <input type="text" id="customerName" name="customerName" required placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å">
                    <div class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="customerPhone"><i class="fas fa-phone"></i> ç”µè¯ <span class="required">*</span></label>
                    <input type="tel" id="customerPhone" name="customerPhone" required placeholder="è¯·è¾“å…¥æ‚¨çš„ç”µè¯å·ç ">
                    <div class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="deliveryMethod"><i class="fas fa-truck"></i> å–è´§æ–¹å¼ <span class="required">*</span></label>
                    <select id="deliveryMethod" name="deliveryMethod" required>
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="self-pickup">è‡ªå–</option>
                        <option value="lalamove">Lalamove</option>
                    </select>
                    <div id="selfPickupAddress" class="pickup-address" style="display: none;">
                        <h4>è‡ªå–åœ°å€:</h4>
                        <p>667, Jalan 24, Taman Perindustrian Ehsan Jaya, Kepong, 52100, Kuala Lumpur.</p>
                        <p><strong>è”ç»œå·ç :</strong> 0162327792</p>
                    </div>
                    <div class="error-message"></div>
                </div>
                <div class="form-group" id="deliveryAddressGroup" style="display: none;">
                    <label for="deliveryAddress"><i class="fas fa-map-marker-alt"></i> é…é€åœ°å€ <span class="required">*</span></label>
                    <textarea id="deliveryAddress" name="deliveryAddress" placeholder="è¯·è¾“å…¥è¯¦ç»†çš„é…é€åœ°å€"></textarea>
                    <div class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="specialRequests"><i class="fas fa-comment"></i> ç‰¹æ®Šè¦æ±‚</label>
                    <textarea id="specialRequests" name="specialRequests" placeholder="ï¼ˆå¯é€‰ï¼‰"></textarea>
                </div>
            </form>
        </section>
        <section class="container" id="productsSection">
            <h2 class="section-title"><i class="fas fa-shopping-basket"></i> è¯·é€‰æ‹©å•†å“</h2>
            <div id="productList" class="product-list"></div>
            <div class="cart-summary" id="cartSummary" style="display:none;">
                <div class="total">æ€»è®¡: <span id="totalAmount">RM0</span></div>
                <div class="item-count">å…± <span id="itemCount">0</span> ä»¶å•†å“</div>
            </div>
        </section>
        <section class="container">
            <h2 class="section-title"><i class="fas fa-credit-card"></i> ä»˜æ¬¾ä¿¡æ¯</h2>
            <div class="form-group">
                <label for="paymentMethod"><i class="fas fa-credit-card"></i> ä»˜æ¬¾æ–¹å¼ <span class="required">*</span></label>
                <select id="paymentMethod" name="paymentMethod" required>
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="maybank">Maybank</option>
                    <option value="touchngo">Touch n Go</option>
                </select>
                <div class="error-message"></div>
            </div>
            <div id="paymentDetails" style="display: none;">
                <div class="bank-info" id="maybankDetails" style="display: none;">
                    <h4><i class="fas fa-university"></i> Maybank</h4>
                    <p><strong>Account Name:</strong> Choong Sher Lee</p>
                    <p><strong>Account No.:</strong> 114209540438</p>
                    <div class="qr-placeholder"><img src="IMG_4043.jpeg" alt="Maybank QR"></div>
                </div>
                <div class="bank-info" id="touchngoDetails" style="display: none;">
                    <h4><i class="fas fa-mobile-alt"></i> Touch n Go</h4>
                    <p><strong>Name:</strong> Choong Sher Lee</p>
                    <p><strong>Phone:</strong> +60162327792</p>
                    <div class="payment-action">
                        <button type="button" class="btn btn-secondary" id="touchngoPayBtn">æ‰“å¼€ App</button>
                    </div>
                    <div class="qr-placeholder"><img src="IMG_4042.png" alt="TNG QR"></div>
                </div>
            </div>
            <div class="form-group" id="paymentProofSection" style="display: none;">
                <label for="paymentProof"><i class="fas fa-upload"></i> ä¸Šä¼ å‡­è¯ <span class="required">*</span></label>
                <div class="file-upload">
                    <input type="file" id="paymentProof" name="paymentProof" accept="image/*" required>
                    <label for="paymentProof" class="file-upload-label">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>ç‚¹å‡»ä¸Šä¼ </span>
                        <span class="file-name"></span>
                    </label>
                </div>
                <div class="error-message"></div>
            </div>
        </section>
        <button type="submit" class="btn submit-btn" id="submitBtn" form="mainForm">
            <i class="fas fa-paper-plane"></i> æäº¤è®¢å•
        </button>
    </main>
    <div id="confirmationDialog" class="dialog-overlay">
        <div class="dialog-content">
            <div class="dialog-header"><h3>ç¡®è®¤è®¢å•</h3></div>
            <div class="dialog-body" id="orderSummary"></div>
            <div class="dialog-footer">
                <button type="button" class="btn btn-secondary" id="cancelOrder">å–æ¶ˆ</button>
                <button type="button" class="btn" id="confirmOrder">ç¡®è®¤</button>
            </div>
        </div>
    </div>
    <div id="successDialog" class="dialog-overlay">
         <div class="dialog-content">
            <div class="dialog-header"><h3><i class="fas fa-check-circle success-icon"></i> è®¢å•æˆåŠŸ</h3></div>
            <div class="dialog-body">
                <p>è®¢å•å·: <strong id="orderNumber"></strong></p>
                <p>è¯·ä¿æŒç”µè¯ç•…é€šã€‚</p>
            </div>
            <div class="dialog-footer"><button type="button" class="btn" id="closeSuccess">å®Œæˆ</button></div>
        </div>
    </div>
    <div id="toastContainer" class="toast-container"></div>
    <div class="admin-section">
        <button class="btn btn-secondary" id="showExportBtn"><i class="fas fa-download"></i> ç®¡ç†å‘˜</button>
        <div id="adminPanel" style="display:none;">
            <input type="password" id="adminPassword" placeholder="å¯†ç " />
            <button class="btn btn-secondary" id="realExportBtn"><i class="fas fa-file-excel"></i> å¯¼å‡º</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://edfnhhthztskuuosuasw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkZm5oaHRoenRza3V1b3N1YXN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5OTYxMTYsImV4cCI6MjA2NTU3MjExNn0.O3g2gjvsWagmWgmzoeJA8mPampvLYJr-KgqVwXsKoAo';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const PhoneFormatter = { format: (value) => value.replace(/\D/g, '') };

        class FormValidator {
            constructor() { this.errors = {}; }
            validateForm(formData) {
                this.errors = {};
                const phoneRegex = /^(\+?6?01)[0-46-9]-?[0-9]{7,8}$/;

                if (!formData.agreeTerms) this.errors.agreeTerms = 'è¯·åŒæ„æ¡æ¬¾';
                if (!formData.customerName) this.errors.customerName = 'è¯·è¾“å…¥å§“å';
                if (!formData.customerPhone || !phoneRegex.test(formData.customerPhone)) this.errors.customerPhone = 'è¯·è¾“å…¥æœ‰æ•ˆç”µè¯';
                if (!formData.deliveryMethod) this.errors.deliveryMethod = 'è¯·é€‰æ‹©å–è´§æ–¹å¼';
                if (formData.deliveryMethod === 'lalamove' && !formData.deliveryAddress) this.errors.deliveryAddress = 'è¯·è¾“å…¥åœ°å€';
                if (!formData.paymentMethod) this.errors.paymentMethod = 'è¯·é€‰æ‹©ä»˜æ¬¾æ–¹å¼';
                if (!formData.paymentProofFile) this.errors.paymentProof = 'è¯·ä¸Šä¼ å‡­è¯';
                
                return Object.keys(this.errors).length === 0;
            }
            showAllErrors() {
                document.querySelectorAll('.form-group.error, .disclaimer-box.error').forEach(el => el.classList.remove('error'));
                for (const fieldName in this.errors) {
                    const errorMsg = this.errors[fieldName];
                    let element = document.getElementById(fieldName)?.closest('.form-group');
                    if (fieldName === 'agreeTerms') element = document.getElementById('disclaimerBox');
                    if (fieldName === 'paymentProof') element = document.getElementById('paymentProofSection');
                    
                    if (element) {
                        element.classList.add('error');
                        element.querySelector('.error-message').textContent = errorMsg;
                    }
                }
                const firstErrorKey = Object.keys(this.errors)[0];
                if (firstErrorKey) {
                    const el = document.getElementById(firstErrorKey) || document.getElementById('disclaimerBox');
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        class FoodOrderApp {
            constructor() {
                this.cart = new Map();
                this.products = [];
                this.validator = new FormValidator();
                this.currentCategory = 'all';
                this.initializeApp();
            }

            async initializeApp() {
                this.showLoading(true);
                await this.loadProducts();
                this.loadInventoryFromStorage();
                this.setupEventListeners();
                this.renderProducts();
                this.updateCartSummary();
                this.showLoading(false);
                this.showToast('åº”ç”¨åŠ è½½æˆåŠŸ', 'success');
                setTimeout(() => this.showInventoryAlerts(), 1500);
            }

            async loadProducts() {
                this.products = [
                    { id: 1, name: 'åŸå‘³çƒ¤è‚ ', price: 28, image: 'IMG_3859.jpeg', category: 'çƒ¤è‚ ç³»åˆ—', emoji: 'ğŸŒ­', stock: 45, minStock: 10 },
                    { id: 2, name: 'çƒŸç†èœœæ±çƒ¤è‚ ', price: 28, image: 'IMG_3864.jpeg', category: 'çƒ¤è‚ ç³»åˆ—', emoji: 'ğŸŒ­', stock: 38, minStock: 10 },
                    { id: 3, name: 'æ³•å¼é¦™è‰çƒ¤è‚ ', price: 28, image: 'IMG_3863.jpeg', category: 'çƒ¤è‚ ç³»åˆ—', emoji: 'ğŸŒ­', stock: 52, minStock: 10 },
                    { id: 4, name: 'é»‘èƒ¡æ¤’çƒ¤è‚ ', price: 28, image: 'IMG_3860.jpeg', category: 'çƒ¤è‚ ç³»åˆ—', emoji: 'ğŸŒ­', stock: 8, minStock: 10 },
                    { id: 5, name: 'å­œç„¶è„†éª¨çƒ¤è‚ ', price: 28, image: 'IMG_3862.jpeg', category: 'çƒ¤è‚ ç³»åˆ—', emoji: 'ğŸŒ­', stock: 23, minStock: 10 },
                    { id: 6, name: 'èŠå£«ç‰ç±³çƒ¤è‚ ', price: 28, image: 'IMG_3861.jpeg', category: 'çƒ¤è‚ ç³»åˆ—', emoji: 'ğŸŒ­', stock: 41, minStock: 10 },
                    { id: 7, name: 'åŸå‘³è™¾è‚ ', price: 33, image: 'IMG_3853.jpeg', category: 'è™¾è‚ ç³»åˆ—', emoji: 'ğŸ¦', stock: 30, minStock: 8 },
                    { id: 8, name: 'è¾£å‘³è™¾è‚ ', price: 33, image: 'IMG_3854.jpeg', category: 'è™¾è‚ ç³»åˆ—', emoji: 'ğŸ¦', stock: 27, minStock: 8 },
                    { id: 9, name: 'åŸå‘³è™¾é¥¼', price: 28, image: 'IMG_3873.jpeg', category: 'è™¾è‚ ç³»åˆ—', emoji: 'ğŸ¤', stock: 19, minStock: 8 },
                    { id: 10, name: 'ç›æ ¼ä¸½ç‰¹æŠ«è¨', price: 25, image: 'IMG_3841.jpeg', category: 'æŠ«è¨ç³»åˆ—', emoji: 'ğŸ•', stock: 15, minStock: 5 },
                    { id: 11, name: 'é»‘æ¤’ç‰›è‚‰æŠ«è¨', price: 25, image: 'IMG_3839.jpeg', category: 'æŠ«è¨ç³»åˆ—', emoji: 'ğŸ•', stock: 12, minStock: 5 },
                    { id: 12, name: 'å¥¥å°”è‰¯é¸¡è‚‰æŠ«è¨', price: 25, image: 'IMG_3840.jpeg', category: 'æŠ«è¨ç³»åˆ—', emoji: 'ğŸ•', stock: 18, minStock: 5 },
                    { id: 13, name: 'åŒæ–™æ¦´è²æŠ«è¨', price: 40, image: 'IMG_3852.jpeg', category: 'æŠ«è¨ç³»åˆ—', emoji: 'ğŸ•', stock: 3, minStock: 3 },
                    { id: 14, name: 'é²œè‚‰å°ç¬¼æ±¤åŒ…', price: 12, image: 'IMG_3874.jpeg', category: 'å°ç¬¼æ±¤åŒ…ç³»åˆ—', emoji: 'ğŸ¥Ÿ', stock: 60, minStock: 15 },
                    { id: 15, name: 'èŒè‡å°ç¬¼æ±¤åŒ…', price: 12, image: 'IMG_3875.jpeg', category: 'å°ç¬¼æ±¤åŒ…ç³»åˆ—', emoji: 'ğŸ¥Ÿ', stock: 45, minStock: 15 },
                    { id: 16, name: 'é»‘æ¾éœ²å°ç¬¼æ±¤åŒ…', price: 12, image: 'IMG_3876.jpeg', category: 'å°ç¬¼æ±¤åŒ…ç³»åˆ—', emoji: 'ğŸ¥Ÿ', stock: 20, minStock: 10 },
                    { id: 17, name: 'é»‘çŒªè‚‰é…¥é¥¼', price: 55, image: 'IMG_3837.jpeg', category: 'é…¥é¥¼ç³»åˆ—', emoji: 'ğŸ¥®', stock: 8, minStock: 5 },
                    { id: 18, name: 'å®‰æ ¼æ–¯ç‰›è‚‰é…¥é¥¼', price: 55, image: 'IMG_3838.jpeg', category: 'é…¥é¥¼ç³»åˆ—', emoji: 'ğŸ¥®', stock: 12, minStock: 5 },
                    { id: 19, name: 'åŸå‘³é¸¡æ’', price: 20, image: 'IMG_3835.jpeg', category: 'é¸¡æ’ç³»åˆ—', emoji: 'ğŸ—', stock: 25, minStock: 8 },
                    { id: 20, name: 'å¥¥å°”è‰¯é¸¡æ’', price: 20, image: 'IMG_3836.jpeg', category: 'é¸¡æ’ç³»åˆ—', emoji: 'ğŸ—', stock: 22, minStock: 8 },
                    { id: 21, name: 'å¥¥å°”è‰¯é¸¡ç¿…', price: 25, image: 'IMG_3865.jpeg', category: 'é¸¡ç¿…ç³»åˆ—', emoji: 'ğŸ—', stock: 35, minStock: 10 },
                    { id: 22, name: 'é’èŠ±æ¤’é¸¡ç¿…', price: 25, image: 'IMG_3866.jpeg', category: 'é¸¡ç¿…ç³»åˆ—', emoji: 'ğŸ—', stock: 28, minStock: 10 },
                    { id: 23, name: 'é»‘çŒªä¸‰ä¸çº¸çš®çƒ§å–', price: 15, image: 'IMG_3843.jpeg', category: 'çº¸çš®çƒ§å–ç³»åˆ—', emoji: 'ğŸ¥Ÿ', stock: 40, minStock: 12 },
                    { id: 24, name: 'é»‘æ¤’ç‰›è‚‰çº¸çš®çƒ§å–', price: 15, image: 'IMG_3842.jpeg', category: 'çº¸çš®çƒ§å–ç³»åˆ—', emoji: 'ğŸ¥Ÿ', stock: 5, minStock: 12 },
                    { id: 25, name: 'é»‘çŒªæ¢…èœå¹²çº¸çš®çƒ§å–', price: 15, image: 'IMG_3844.jpeg', category: 'çº¸çš®çƒ§å–ç³»åˆ—', emoji: 'ğŸ¥Ÿ', stock: 32, minStock: 12 },
                    { id: 26, name: 'ä¸‰ä¸èŠå£«çº¸çš®çƒ§å–', price: 15, image: 'IMG_3845.jpeg', category: 'çº¸çš®çƒ§å–ç³»åˆ—', emoji: 'ğŸ¥Ÿ', stock: 0, minStock: 12 },
                    { id: 27, name: 'ä¹Œç±³è…Šå‘³çº¸çš®çƒ§å–', price: 15, image: 'IMG_3846.jpeg', category: 'çº¸çš®çƒ§å–ç³»åˆ—', emoji: 'ğŸ¥Ÿ', stock: 18, minStock: 12 }
                ];
            }
            
            loadInventoryFromStorage() {
                try {
                    const saved = localStorage.getItem('inventoryData');
                    if (saved) {
                        const inventoryData = JSON.parse(saved);
                        inventoryData.forEach(item => {
                            const product = this.products.find(p => p.id === item.id);
                            if (product) product.stock = item.stock;
                        });
                    }
                } catch (e) { console.error("Failed to load inventory from storage", e); }
            }

            setupEventListeners() {
                document.getElementById('categoryNav').addEventListener('click', (e) => {
                    if (e.target.matches('.category-link')) {
                        e.preventDefault();
                        this.handleCategoryChange(e.target.dataset.category);
                    }
                });
                document.getElementById('mainForm').addEventListener('submit', (e) => { e.preventDefault(); this.handleFormSubmit(); });
                document.getElementById('deliveryMethod').addEventListener('change', this.handleDeliveryChange);
                document.getElementById('paymentMethod').addEventListener('change', this.handlePaymentChange.bind(this));
                document.getElementById('paymentProof').addEventListener('change', this.handleFileUpload.bind(this));
                document.getElementById('customerPhone').addEventListener('input', (e) => e.target.value = PhoneFormatter.format(e.target.value));
                document.getElementById('cancelOrder').addEventListener('click', () => this.hideDialog('confirmationDialog'));
                document.getElementById('confirmOrder').addEventListener('click', () => this.submitOrder());
                document.getElementById('closeSuccess').addEventListener('click', () => this.hideDialog('successDialog'));
                document.getElementById('showExportBtn').addEventListener('click', () => {
                    document.getElementById('adminPanel').style.display = document.getElementById('adminPanel').style.display === 'none' ? 'block' : 'none';
                });
                document.getElementById('realExportBtn').addEventListener('click', () => this.handleAdminExport(document.getElementById('adminPassword').value));
                document.getElementById('touchngoPayBtn').addEventListener('click', () => window.open('https://touchngo.com.my/ewallet/', '_blank'));
            }

            renderProducts() {
                let filtered = this.products;
                if (this.currentCategory !== 'all') {
                    filtered = this.products.filter(p => p.category === this.currentCategory);
                }
                document.getElementById('productList').innerHTML = filtered.map(p => this.renderProduct(p)).join('');
                this.attachQuantityListeners();
            }

            renderProduct(product) {
                const quantity = this.cart.get(product.id) || 0;
                const stockStatus = this.getStockStatus(product);
                const isOutOfStock = product.stock === 0;
                return `
                    <div class="product ${isOutOfStock ? 'out-of-stock' : ''}" data-product-id="${product.id}">
                        ${stockStatus.badge}
                        <div class.product-image-container"><img src="${product.image}" alt="${product.name}" class="product-image"></div>
                        <div class="product-name">${product.emoji} ${product.name}</div>
                        <div class="product-price">RM${product.price.toFixed(2)}</div>
                        <div class="stock-info ${stockStatus.class}"><i class="fas ${stockStatus.icon}"></i> åº“å­˜: ${product.stock > 0 ? `${product.stock} ä»¶` : 'å·²å”®å®Œ'}</div>
                        <div class="quantity-control">
                            <button class="quantity-btn" data-action="decrease" ${quantity === 0 || isOutOfStock ? 'disabled' : ''}><i class="fas fa-minus"></i></button>
                            <input type="number" class="quantity-input" value="${quantity}" min="0" max="${product.stock}" ${isOutOfStock ? 'disabled' : ''}>
                            <button class="quantity-btn" data-action="increase" ${quantity >= product.stock || isOutOfStock ? 'disabled' : ''}><i class="fas fa-plus"></i></button>
                        </div>
                    </div>`;
            }

            attachQuantityListeners() {
                document.querySelectorAll('.quantity-control').forEach(control => {
                    const productId = parseInt(control.closest('.product').dataset.productId);
                    control.querySelector('.quantity-btn[data-action="increase"]').addEventListener('click', () => this.updateQuantity(productId, 'increase'));
                    control.querySelector('.quantity-btn[data-action="decrease"]').addEventListener('click', () => this.updateQuantity(productId, 'decrease'));
                    control.querySelector('.quantity-input').addEventListener('change', (e) => this.setQuantity(productId, parseInt(e.target.value) || 0));
                });
            }

            handleCategoryChange(category) {
                this.currentCategory = category;
                document.querySelectorAll('.category-link').forEach(link => link.classList.toggle('active', link.dataset.category === category));
                this.renderProducts();
            }

            handleDeliveryChange(e) {
                document.getElementById('deliveryAddressGroup').style.display = e.target.value === 'lalamove' ? 'block' : 'none';
                document.getElementById('selfPickupAddress').style.display = e.target.value === 'self-pickup' ? 'block' : 'none';
            }

            handlePaymentChange(e) {
                const method = e.target.value;
                document.getElementById('paymentDetails').style.display = method ? 'block' : 'none';
                document.getElementById('paymentProofSection').style.display = method ? 'block' : 'none';
                document.getElementById('maybankDetails').style.display = method === 'maybank' ? 'block' : 'none';
                document.getElementById('touchngoDetails').style.display = method === 'touchngo' ? 'block' : 'none';
            }

            handleFileUpload(event) {
                document.querySelector('.file-name').textContent = event.target.files[0] ? event.target.files[0].name : '';
            }

            updateQuantity(productId, action) {
                let quantity = this.cart.get(productId) || 0;
                const product = this.products.find(p => p.id === productId);
                if (action === 'increase' && quantity < product.stock) quantity++;
                else if (action === 'decrease' && quantity > 0) quantity--;
                this.setQuantity(productId, quantity);
            }
            
            setQuantity(productId, quantity) {
                const product = this.products.find(p => p.id === productId);
                if (quantity > product.stock) {
                    quantity = product.stock;
                    this.showToast(`åº“å­˜ä¸è¶³`, 'warning');
                }
                if (quantity > 0) this.cart.set(productId, quantity); else this.cart.delete(productId);
                this.updateCartSummary();
                const el = document.querySelector(`.product[data-product-id="${productId}"]`);
                if(el) {
                    el.querySelector('.quantity-input').value = quantity;
                    el.querySelector('[data-action="decrease"]').disabled = quantity === 0;
                    el.querySelector('[data-action="increase"]').disabled = quantity >= product.stock;
                }
            }

            updateCartSummary() {
                let total = 0, count = 0;
                this.cart.forEach((q, id) => {
                    const p = this.products.find(pr => pr.id === id);
                    if(p) { total += p.price * q; count += q; }
                });
                document.querySelector('#cartSummary .total').textContent = `æ€»è®¡: RM${total.toFixed(2)}`;
                document.querySelector('#cartSummary .item-count').textContent = `å…± ${count} ä»¶å•†å“`;
                document.getElementById('cartSummary').style.display = count > 0 ? 'block' : 'none';
            }

            getStockStatus(product) {
                if (product.stock === 0) return { class: 'out-of-stock', icon: 'fa-times-circle', badge: '<div class="stock-badge out-of-stock-badge">å”®å®Œ</div>' };
                if (product.stock <= product.minStock) return { class: 'low-stock', icon: 'fa-exclamation-triangle', badge: '<div class="stock-badge low-stock-badge">åº“å­˜ä¸è¶³</div>' };
                return { class: 'in-stock', icon: 'fa-check-circle', badge: '' };
            }
            
            saveInventoryToStorage() {
                localStorage.setItem('inventoryData', JSON.stringify(this.products.map(p => ({ id: p.id, stock: p.stock }))));
            }

            showInventoryAlerts() {
                const lowStock = this.products.filter(p => p.stock > 0 && p.stock <= p.minStock);
                if (lowStock.length > 0) this.showToast(`${lowStock.map(p=>p.name).slice(0,2).join(', ')}ç­‰åº“å­˜ä¸è¶³`, 'warning');
                const outOfStock = this.products.filter(p => p.stock === 0);
                if (outOfStock.length > 0) this.showToast(`${outOfStock.map(p=>p.name).join(', ')}å·²å”®å®Œ`, 'danger');
            }

            async handleFormSubmit() {
                if (this.cart.size === 0) { return this.showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä»¶å•†å“', 'warning'); }
                const formData = this.collectFormData();
                if (!this.validator.validateForm(formData)) {
                    this.validator.showAllErrors();
                    return this.showToast('è¯·æ£€æŸ¥è¡¨å•', 'error');
                }
                this.showConfirmationDialog(formData);
            }
            
            collectFormData() {
                const form = document.getElementById('mainForm');
                return {
                    agreeTerms: form.agreeTerms.checked, customerName: form.customerName.value.trim(),
                    customerPhone: form.customerPhone.value.trim(), deliveryMethod: form.deliveryMethod.value,
                    deliveryAddress: form.deliveryAddress.value.trim(), paymentMethod: form.paymentMethod.value,
                    specialRequests: form.specialRequests.value.trim(), paymentProofFile: form.paymentProof.files[0],
                    cart: Array.from(this.cart.entries()).map(([id, q]) => ({ ...this.products.find(p => p.id === id), quantity: q }))
                };
            }
            
            showConfirmationDialog(formData) {
                this.pendingOrderData = formData;
                const total = formData.cart.reduce((s, i) => s + i.price * i.quantity, 0);
                document.getElementById('orderSummary').innerHTML = `
                    <p><strong>å§“å:</strong> ${formData.customerName}</p>
                    <p><strong>ç”µè¯:</strong> ${formData.customerPhone}</p>
                    <hr><h4>å•†å“:</h4>
                    <ul>${formData.cart.map(i => `<li>${i.name} x ${i.quantity}</li>`).join('')}</ul>
                    <h4>æ€»è®¡: RM${total.toFixed(2)}</h4>`;
                this.showDialog('confirmationDialog');
            }

            async submitOrder() {
                if (!this.pendingOrderData) return;
                this.hideDialog('confirmationDialog');
                this.showLoading(true);
                try {
                    const orderData = this.pendingOrderData;
                    const orderNumber = await this.generateOrderNumber();
                    const { publicUrl } = await this.uploadProof(orderData.paymentProofFile, orderNumber);
                    
                    const { error } = await supabase.from('orders').insert([{
                        order_id: orderNumber, name: orderData.customerName, phone: orderData.customerPhone,
                        delivery_method: orderData.deliveryMethod, delivery_address: orderData.deliveryAddress,
                        remarks: orderData.specialRequests, payment_method: orderData.paymentMethod,
                        order_items: orderData.cart.map(({id, name, price, quantity})=>({id, name, price, quantity})),
                        total_amount: orderData.cart.reduce((s,i)=>s+i.price*i.quantity,0),
                        payment_proof_url: publicUrl, status: 'pending'
                    }]);
                    if (error) throw error;
                    
                    orderData.cart.forEach(item => {
                        const product = this.products.find(p => p.id === item.id);
                        if(product) product.stock -= item.quantity;
                    });
                    this.saveInventoryToStorage();
                    this.showSuccessDialog(orderNumber);
                } catch (error) {
                    this.showToast(`æäº¤å¤±è´¥: ${error.message}`, 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            async uploadProof(file, orderId) {
                if (!file) return { publicUrl: '' };
                const fileName = `proofs/${orderId}.${file.name.split('.').pop()}`;
                const { error } = await supabase.storage.from('payment-proofs').upload(fileName, file, { upsert: true });
                if (error) throw new Error('å‡­è¯ä¸Šä¼ å¤±è´¥');
                const { data } = supabase.storage.from('payment-proofs').getPublicUrl(fileName);
                return data;
            }
            
            showSuccessDialog(orderNumber) {
                document.getElementById('orderNumber').textContent = orderNumber;
                this.showDialog('successDialog');
                const closeBtn = document.getElementById('closeSuccess');
                const newCloseBtn = closeBtn.cloneNode(true);
                closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
                newCloseBtn.addEventListener('click', () => {
                    this.hideDialog('successDialog');
                    this.resetForm();
                });
            }

            resetForm() {
                document.getElementById('mainForm').reset();
                this.cart.clear();
                this.renderProducts();
                this.updateCartSummary();
                document.querySelector('.file-name').textContent = '';
                document.getElementById('deliveryAddressGroup').style.display = 'none';
                document.getElementById('paymentDetails').style.display = 'none';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            
            async generateOrderNumber() {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                const datePrefix = `FW${yyyy}${mm}${dd}`;
                const { count, error } = await supabase.from('orders').select('order_id', { count: 'exact', head: true }).like('order_id', `${datePrefix}%`);
                if (error) {
                    console.error("Error fetching order count:", error);
                    return `FW-ERR-${Date.now().toString().slice(-8)}`;
                }
                const sequence = String(count + 1).padStart(3, '0');
                return `${datePrefix}${sequence}`;
            }

            showDialog(id) { document.getElementById(id).classList.add('show'); }
            hideDialog(id) { document.getElementById(id).classList.remove('show'); }
            showLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }
            showToast(message, type = 'info') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
                toast.innerHTML = `<i class="fas ${icons[type]}"></i><span>${message}</span>`;
                container.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            async handleAdminExport(password) {
                if (password !== 'fengweipaiadmin') { return this.showToast('å¯†ç é”™è¯¯', 'error'); }
                this.showLoading(true);
                try {
                    const { data, error } = await supabase.from('orders').select('*').order('created_at', { ascending: false });
                    if (error) throw error;
                    const wsData = [['è®¢å•å·', 'å§“å', 'ç”µè¯', 'å–è´§æ–¹å¼', 'åœ°å€', 'å¤‡æ³¨', 'æ€»é‡‘é¢', 'çŠ¶æ€', 'ä¸‹å•æ—¶é—´', 'æ”¯ä»˜å‡­è¯', 'å•†å“']];
                    data.forEach(o => wsData.push([ o.order_id, o.name, o.phone, o.delivery_method, o.delivery_address, o.remarks, o.total_amount, o.status, new Date(o.created_at).toLocaleString(), o.payment_proof_url, o.order_items.map(i => `${i.name}x${i.quantity}`).join('; ') ]));
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), 'Orders');
                    XLSX.writeFile(wb, `Orders_${new Date().toISOString().slice(0,10)}.xlsx`);
                } catch (err) { this.showToast(`å¯¼å‡ºå¤±è´¥: ${err.message}`, 'error'); } 
                finally { this.showLoading(false); }
            }
        }

        document.addEventListener('DOMContentLoaded', () => { window.app = new FoodOrderApp(); });
    </script>
</body>
</html>